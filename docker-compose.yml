# ============================================
# Docker Compose Configuration
# Multi-Environment Deployment for Portfolio
# ============================================
#
# INSTRUCTIONS:
# 1. Ensure Dockerfile exists in the project root
# 2. Set PROJECT_NAME environment variable if needed (defaults to "portfolio")
# 3. Adjust ports if they conflict with other services
#
# USAGE:
#   Start staging:    docker compose up staging -d
#   Start production: docker compose up production -d
#   Start both:       docker compose up -d
#   Stop all:         docker compose down
#   View logs:        docker compose logs -f [staging|production]
#   Rebuild:          docker compose build --no-cache
#
# ============================================

services:
  # ==========================================
  # STAGING ENVIRONMENT
  # ==========================================
  # Purpose: Testing new features before production
  # URL: http://localhost:5000
  # ==========================================
  staging:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: ${PROJECT_NAME:-portfolio}-staging
    ports:
      - "5000:3000"
    environment:
      - NODE_ENV=staging
      - PORT=3000
      - HOSTNAME=0.0.0.0
      - APP_NAME=${PROJECT_NAME:-Portfolio} (STAGING)
      # Add any other environment variables your app needs
      # - DATABASE_URL=...
      # - API_KEY=...
      # - RESEND_API_KEY=...
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000/api/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)}).on('error', () => process.exit(1))"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped
    networks:
      - app-network

  # ==========================================
  # PRODUCTION ENVIRONMENT
  # ==========================================
  # Purpose: Stable release for end users
  # URL: http://localhost:6001
  # ==========================================
  production:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: ${PROJECT_NAME:-portfolio}-production
    ports:
      - "6001:3000"
    environment:
      - NODE_ENV=production
      - PORT=3000
      - HOSTNAME=0.0.0.0
      - APP_NAME=${PROJECT_NAME:-Portfolio} (PRODUCTION)
      # Add any other environment variables your app needs
      # - DATABASE_URL=...
      # - API_KEY=...
      # - RESEND_API_KEY=...
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000/api/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)}).on('error', () => process.exit(1))"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped
    networks:
      - app-network

# ==========================================
# NETWORKS
# ==========================================
networks:
  app-network:
    driver: bridge

# ==========================================
# OPTIONAL: DATABASE SERVICES
# ==========================================
# Uncomment and configure if your app needs a database
#
#   database:
#     image: postgres:15-alpine    # or mysql:8, mongo:6, etc.
#     container_name: ${PROJECT_NAME:-portfolio}-db
#     environment:
#       - POSTGRES_USER=appuser
#       - POSTGRES_PASSWORD=apppassword
#       - POSTGRES_DB=appdb
#     volumes:
#       - db-data:/var/lib/postgresql/data
#     networks:
#       - app-network
#
# volumes:
#   db-data:

